<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.3.1"><meta name=author content="Max Woolf"><meta name=description content="Manipulating actually-big-data is just as easy as performing an analysis on a dataset with only a few records."><link rel=alternate hreflang=en-us href=https://minimaxir.com/2017/01/amazon-spark/><meta name=theme-color content=#2962ff><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.6.0/css/all.css integrity=sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,700|Source+Code+Pro:400,400italic,700&display=swap"><link rel=stylesheet href=/css/academic.min.4cdedb6ca5fc8a13caf3e26423bf7037.css><link rel=stylesheet href=/css/academic.59da4f61e2de6d8a5935b902fe667ab3.css><link rel=manifest href=/site.webmanifest><link rel=icon type=image/png href=/img/icon.png><link rel=apple-touch-icon type=image/png href=/img/icon-192.png><link rel=canonical href=https://minimaxir.com/2017/01/amazon-spark/><meta property=twitter:card content=summary_large_image><meta property=twitter:site content=@minimaxir><meta property=twitter:creator content=@minimaxir><meta property=article:author content=https://www.facebook.com/max.woolf><meta property=og:site_name content="Max Woolf's Blog"><meta property=og:url content=https://minimaxir.com/2017/01/amazon-spark/><meta property=og:type content=article><meta property=og:title content="Playing with 80 Million Amazon Product Review Ratings Using Apache Spark"><meta property=og:description content="Manipulating actually-big-data is just as easy as performing an analysis on a dataset with only a few records."><meta property=og:image content=https://minimaxir.com/2017/01/amazon-spark/featured.png><meta property=twitter:image content=https://minimaxir.com/2017/01/amazon-spark/featured.png><meta property=og:locale content=en-us><meta property=article:published_time content=2017-01-02T09:00:00-07:00><meta property=article:modified_time content=2017-01-02T09:00:00-07:00><title>Playing with 80 Million Amazon Product Review Ratings Using Apache Spark | Max Woolf&#39;s Blog</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id=navbar-main><div class=container><a class=navbar-brand href=/>Max Woolf&#39;s Blog</a>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="collapse navbar-collapse" id=navbar><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about/><span>About</span></a></li><li class=nav-item><a class=nav-link href=/post/><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/portfolio/><span>Portfolio</span></a></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://www.patreon.com/minimaxir target=_blank rel=noopener><span><i class="fab fa-patreon mr-1"></i>Patreon</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/minimaxir target=_blank rel=noopener><span><i class="fab fa-github-alt mr-1"></i>GitHub</span></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></div></nav><article class=article itemscope itemtype=http://schema.org/Article><div class="article-container pt-3"><h1 itemprop=name>Playing with 80 Million Amazon Product Review Ratings Using Apache Spark</h1><meta content="2017-01-02 09:00:00 -0700 -0700" itemprop=datePublished><meta content="2017-01-02 09:00:00 -0700 -0700" itemprop=dateModified><div class=article-metadata><span class=article-date><time>January 2, 2017</time></span>
<span class=middot-divider></span><span class=article-reading-time>7 min read</span>
<span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/categories/data-science/>Data Science</a>, <a href=/categories/big-data/>Big Data</a></span><div class=share-box aria-hidden=true><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https://minimaxir.com/2017/01/amazon-spark/&amp;text=Playing%20with%2080%20Million%20Amazon%20Product%20Review%20Ratings%20Using%20Apache%20Spark" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https://minimaxir.com/2017/01/amazon-spark/&amp;t=Playing%20with%2080%20Million%20Amazon%20Product%20Review%20Ratings%20Using%20Apache%20Spark" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook-f"></i></a></li><li><a href="mailto:?subject=Playing%20with%2080%20Million%20Amazon%20Product%20Review%20Ratings%20Using%20Apache%20Spark&amp;body=https://minimaxir.com/2017/01/amazon-spark/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https://minimaxir.com/2017/01/amazon-spark/&amp;title=Playing%20with%2080%20Million%20Amazon%20Product%20Review%20Ratings%20Using%20Apache%20Spark" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="https://reddit.com/submit?url=https://minimaxir.com/2017/01/amazon-spark/&amp;title=Playing%20with%2080%20Million%20Amazon%20Product%20Review%20Ratings%20Using%20Apache%20Spark" target=_blank rel=noopener class=share-btn-reddit><i class="fab fa-reddit-alien"></i></a></li></ul></div></div></div><div class=article-container><div class=article-style itemprop=articleBody><p><a href=https://www.amazon.com target=_blank>Amazon</a> product reviews and ratings are a very important business. Customers on Amazon often make purchasing decisions based on those reviews, and a single bad review can cause a potential purchaser to reconsider. A couple years ago, I wrote a blog post titled <a href=http://minimaxir.com/2014/06/reviewing-reviews/ target=_blank>A Statistical Analysis of 1.2 Million Amazon Reviews</a>, which was well-received.</p><p><img src=/img/amazon/amzn-basic-score.png alt></p><p>Back then, I was only limited to 1.2M reviews because attempting to process more data caused out-of-memory issues and my R code took <em>hours</em> to run.</p><p><a href=http://spark.apache.org target=_blank>Apache Spark</a>, which makes processing gigantic amounts of data efficient and sensible, has become very popular in the past couple years (for good tutorials on using Spark with Python, I recommend the <a href=https://courses.edx.org/courses/course-v1:BerkeleyX+CS105x+1T2016/info target=_blank>free</a> <a href=https://courses.edx.org/courses/course-v1:BerkeleyX+CS110x+2T2016/info target=_blank>eDX</a> <a href=https://courses.edx.org/courses/course-v1:BerkeleyX+CS120x+2T2016/info target=_blank>courses</a>). Although data scientists often use Spark to process data with distributed cloud computing via <a href=https://aws.amazon.com/ec2/ target=_blank>Amazon EC2</a> or <a href=https://azure.microsoft.com/en-us/services/hdinsight/apache-spark/ target=_blank>Microsoft Azure</a>, Spark works just fine even on a typical laptop, given enough memory (for this post, I use a 2016 MacBook Pro/16GB RAM, with 8GB allocated to the Spark driver).</p><p>I wrote a <a href=https://github.com/minimaxir/amazon-spark/blob/master/amazon_preprocess.py target=_blank>simple Python script</a> to combine the per-category ratings-only data from the <a href=http://jmcauley.ucsd.edu/data/amazon/ target=_blank>Amazon product reviews dataset</a> curated by Julian McAuley, Rahul Pandey, and Jure Leskovec for their 2015 paper <a href=http://cseweb.ucsd.edu/~jmcauley/pdfs/kdd15.pdf target=_blank>Inferring Networks of Substitutable and Complementary Products</a>. The result is a 4.53 GB CSV that would definitely not open in Microsoft Excel. The truncated and combined dataset includes the <strong>user_id</strong> of the user leaving the review, the <strong>item_id</strong> indicating the Amazon product receiving the review, the <strong>rating</strong> the user gave the product from 1 to 5, and the <strong>timestamp</strong> indicating the time when the review was written (truncated to the Day). We can also infer the <strong>category</strong> of the reviewed product from the name of the data subset.</p><p>Afterwards, using the new <a href=http://spark.rstudio.com target=_blank>sparklyr</a> package for R, I can easily start a local Spark cluster with a single <code>spark_connect()</code> command and load the entire CSV into the cluster in seconds with a single <code>spark_read_csv()</code> command.</p><p><img src=/img/amazon-spark/output.png alt></p><p>There are 80.74 million records total in the dataset, or as the output helpfully reports, <code>8.074e+07</code> records. Performing advanced queries with traditional tools like <a href=https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html target=_blank>dplyr</a> or even Python&rsquo;s <a href=http://pandas.pydata.org target=_blank>pandas</a> on such a dataset would take a considerable amount of time to execute.</p><p>With sparklyr, manipulating actually-big-data is <em>just as easy</em> as performing an analysis on a dataset with only a few records (and an order of magnitude easier than the Python approaches taught in the eDX class mentioned above!).</p><h2 id=exploratory-analysis>Exploratory Analysis</h2><p><em>(You can view the R code used to process the data with Spark and generate the data visualizations in <a href=http://minimaxir.com/notebooks/amazon-spark/ target=_blank>this R Notebook</a>)</em></p><p>There are <strong>20,368,412</strong> unique users who provided reviews in this dataset. <strong>51.9%</strong> of those users have only written one review.</p><p><img src=/img/amazon-spark/user_count_cum.png alt></p><p>Relatedly, there are <strong>8,210,439</strong> unique products in this dataset, where <strong>43.3%</strong> have only one review.</p><p><img src=/img/amazon-spark/item_count_cum.png alt></p><p>After removing duplicate ratings, I added a few more features to each rating which may help illustrate how review behavior changed over time: a ranking value indicating the # review that the author of a given review has written (1st review by author, 2nd review by author, etc.), a ranking value indicating the # review that the product of a given review has received (1st review for product, 2nd review for product, etc.), and the month and year the review was made.</p><p>The first two added features require a <em>very</em> large amount of processing power, and highlight the convenience of Spark&rsquo;s speed (and the fact that Spark uses all CPU cores by default, while typical R/Python approaches are single-threaded!)</p><p>These changes are cached into a Spark DataFrame <code>df_t</code>. If I wanted to determine which Amazon product category receives the best review ratings on average, I can aggregate the data by category, calculate the average rating score for each category, and sort. Thanks to the power of Spark, the data processing for this many-millions-of-records takes seconds.</p><pre><code class=language-r>df_agg &lt;- df_t %&gt;%
            group_by(category) %&gt;%
            summarize(count = n(), avg_rating = mean(rating)) %&gt;%
            arrange(desc(avg_rating)) %&gt;%
            collect()
</code></pre><p><img src=/img/amazon-spark/avg.png alt></p><p>Or, visualized in chart form using <a href=http://ggplot2.org target=_blank>ggplot2</a>:</p><p><img src=/img/amazon-spark/avg_rating_desc.png alt></p><p>Digital Music/CD products receive the highest reviews on average, while Video Games and Cell Phones receive the lowest reviews on average, with a <strong>0.77</strong> rating range between them. This does make some intuitive sense; Digital Music and CDs are types of products where you know <em>exactly</em> what you are getting with no chance of a random product defect, while Cell Phones and Accessories can have variable quality from shady third-party sellers (Video Games in particular are also prone to irrational <a href=http://steamed.kotaku.com/steam-games-are-now-even-more-susceptible-to-review-bom-1774940065 target=_blank>review bombing</a> over minor grievances).</p><p>We can refine this visualization by splitting each bar into a percentage breakdown of each rating from 1-5. This could be plotted with a pie chart for each category, however a stacked bar chart, scaled to 100%, looks much cleaner.</p><p><img src=/img/amazon-spark/category_breakdown.png alt></p><p>The new visualization does help support the theory above; the top categories have a significantly higher percentage of 4/5-star ratings than the bottom categories, and a much a lower proportion of 1/2/3-star ratings. The inverse holds true for the bottom categories.</p><p>How have these breakdowns changed over time? Are there other factors in play?</p><h2 id=rating-breakdowns-over-time>Rating Breakdowns Over Time</h2><p>Perhaps the advent of the binary Like/Dislike behaviors in social media in the 2000&rsquo;s have translated into a change in behavior for a 5-star review system. Here are the rating breakdowns for reviews written in each month from January 2000 to July 2014:</p><p><img src=/img/amazon-spark/time_breakdown.png alt></p><p>The voting behavior oscillates very slightly over time with no clear spikes or inflection points, which dashes that theory.</p><h2 id=distribution-of-average-scores>Distribution of Average Scores</h2><p>We should look at the global averages of Amazon product scores (i.e. what customers see when they buy products), and the users who give the ratings. We would expect the distributions to match, so any deviations would be interesting.</p><p>Products on average, when looking at products with atleast 5 ratings, have a <strong>4.16</strong> overall rating.</p><p><img src=/img/amazon-spark/item_histogram.png alt></p><p>When looking at a similar graph for the overall ratings given by users, (5 ratings minimum), the average rating is slightly higher at <strong>4.20</strong>.</p><p><img src=/img/amazon-spark/user_histogram.png alt></p><p>The primary difference between the two distributions is that there is significantly higher proportion of Amazon customers giving <em>only</em> 5-star reviews. Normalizing and overlaying the two charts clearly highlights that discrepancy.</p><p><img src=/img/amazon-spark/user_item_histogram.png alt></p><h2 id=the-marginal-review>The Marginal Review</h2><p>A few posts ago, I discussed how the <a href=http://minimaxir.com/2016/11/first-comment/ target=_blank>first comment on a Reddit post</a> has dramatically more influence than subsequent comments. Does user rating behavior change after making more and more reviews? Is the typical rating behavior different for the first review of a given product?</p><p>Here is the ratings breakdown for the <em>n</em>-th Amazon review a user gives:</p><p><img src=/img/amazon-spark/user_nth_breakdown.png alt></p><p>The first user review has a slightly higher proportion of being a 1-star review than subsequent reviews. Otherwise, the voting behavior is mostly the same overtime, although users have an increased proportion of giving a 4-star review instead of a 5-star review as they get more comfortable.</p><p>In contrast, here is the ratings breakdown for the <em>n</em>-th review an Amazon product received:</p><p><img src=/img/amazon-spark/item_nth_breakdown.png alt></p><p>The first product review has a slightly higher proportion of being a 5-star review than subsequent reviews. However, after the 10th review, there is <em>zero</em> change in the distribution of ratings, which implies that the marginal rating behavior is independent from the current score after that threshold.</p><h2 id=summary>Summary</h2><p>Granted, this blog post is more playing with data and less analyzing data. What might be interesting to look into for future technical posts is conditional behavior, such as predicting the rating of a review given the previous ratings on that product/by that user. However, this post shows that while &ldquo;big data&rdquo; may be an inscrutable buzzword nowadays, you don&rsquo;t have to work for a Fortune 500 company to be able to understand it. Even with a data set consisting of 5 simple features, you can extract a large number of insights.</p><p>And this post doesn&rsquo;t even look at the text of the Amazon product reviews or the metadata associated with the products! I do have a few ideas lined up there which I won&rsquo;t spoil.</p><hr><p><em>You can view all the R and ggplot2 code used to visualize the Amazon data in <a href=http://minimaxir.com/notebooks/amazon-spark/ target=_blank>this R Notebook</a>. You can also view the images/data used for this post in <a href=https://github.com/minimaxir/amazon-spark target=_blank>this GitHub repository</a></em>.</p><p><em>You are free to use the data visualizations from this article however you wish, but it would be greatly appreciated if proper attribution is given to this article and/or myself!</em></p><div class="alert alert-note"><div>If you liked this blog post, I have set up a <a href=https://www.patreon.com/minimaxir target=_blank>Patreon</a> to fund my machine learning/deep learning/software/hardware needs for my future crazy yet cool projects, and any monetary contributions to the Patreon are appreciated and will be put to good creative use.</div></div></div><div class=article-tags><a class="badge badge-light" href=/tags/r/>R</a>
<a class="badge badge-light" href=/tags/ggplot2/>ggplot2</a></div><div class="media author-card" itemscope itemtype=http://schema.org/Person><img class="portrait mr-3" src="https://s.gravatar.com/avatar/28f09e3deff62333b3f32f19d3971d46?s=200')" itemprop=image alt=Avatar><div class=media-body><h5 class=card-title itemprop=name><a href=https://minimaxir.com/>Max Woolf</a></h5><h6 class=card-subtitle>Data Scientist at BuzzFeed</h6><p class=card-text itemprop=description>Ex-Apple. Carnegie Mellon graduate. Plotter of pretty charts. Former TechCrunch comment troll.</p><ul class=network-icon aria-hidden=true><li><a itemprop=sameAs href=https://twitter.com/minimaxir target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a itemprop=sameAs href=https://linkedin.com/in/minimaxir target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a itemprop=sameAs href=https://youtube.com/minimaxir target=_blank rel=noopener><i class="fab fa-youtube"></i></a></li><li><a itemprop=sameAs href=https://twitch.tv/minimaxir target=_blank rel=noopener><i class="fab fa-twitch"></i></a></li><li><a itemprop=sameAs href=mailto:max@minimaxir.com><i class="fas fa-envelope"></i></a></li></ul></div></div><div class=article-widget><div class=hr-light></div><h3>Related</h3><ul><li><a href=/2016/11/first-comment/>What Percent of the Top-Voted Comments in Reddit Threads Were Also 1st Comment?</a></li><li><a href=/2016/07/stack-overflow/>Visualizing How Developers Rate Their Own Programming Skills</a></li><li><a href=/2016/06/reddit-related-subreddits/>Methods for Finding Related Reddit Subreddits with Simple Set Theory</a></li><li><a href=/2016/05/reddit-graph/>How to Create a Network Graph Visualization of Reddit Subreddits</a></li><li><a href=/2016/04/movie-gender/>Blockbuster Movies with Male Leads Earn More Than Those with Female Leads</a></li></ul></div><div class=article-widget><div class=post-nav><div class=post-nav-item><div class=meta-nav>Next</div><a href=/2017/02/predicting-arrests/ rel=next>Predicting And Mapping Arrest Types in San Francisco with LightGBM, R, ggplot2</a></div><div class=post-nav-item><div class=meta-nav>Previous</div><a href=/2016/11/first-comment/ rel=prev>What Percent of the Top-Voted Comments in Reddit Threads Were Also 1st Comment?</a></div></div></div><section id=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"minimaxir"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin=anonymous></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/r.min.js></script><script>hljs.initHighlightingOnLoad();</script><script src=/js/academic.min.bc1d5e4f014b8d38d75521ad1ae2ab18.js></script><div class=container><footer class=site-footer><p class=powered-by>Copyright Max Woolf &copy; 2019 &middot;
Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# id=back_to_top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&times;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>